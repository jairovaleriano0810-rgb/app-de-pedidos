<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Sabor Ecuatoriano</title>

    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Work+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='notifications.css') }}">
    
    <style>
        /* Bot√≥n Clean peque√±o y compacto */
        .clean-all-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 15px;
        }

        .clean-all-btn:hover {
            background: linear-gradient(135deg, #e53935 0%, #d81b60 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.5);
        }

        .clean-all-btn:active {
            transform: translateY(0);
        }

        /* Modal de confirmaci√≥n de limpieza */
        .clean-confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .clean-confirm-modal.show {
            display: flex;
        }

        .clean-confirm-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popup 0.4s ease;
            text-align: center;
        }

        .clean-confirm-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .clean-confirm-box h3 {
            font-family: 'Righteous', cursive;
            color: #f44336;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .clean-confirm-box p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .clean-confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .clean-confirm-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel-clean {
            background: #e0e0e0;
            color: #333;
        }

        .btn-cancel-clean:hover {
            background: #d0d0d0;
        }

        .btn-confirm-clean {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
        }

        .btn-confirm-clean:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.5);
        }
    </style>
</head>

<body>
    <!-- ============================================
         INDICADOR DE ESTADO ABIERTO/CERRADO
    ============================================ -->
    <div class="restaurant-status" id="restaurantStatus">
        <div class="status-indicator status-open" id="statusIndicator"></div>
        <span class="status-text-open" id="statusText">ABIERTO</span>
    </div>

    <!-- INDICADOR DE NOTIFICACIONES -->
    <div class="notifications-indicator active" id="notificationsIndicator" style="display: none;">
        <div class="notification-dot" id="notificationDot"></div>
        <span id="notificationStatus">Notificaciones Activas</span>
    </div>

    <!-- BOT√ìN PARA ACTIVAR NOTIFICACIONES -->
    <button class="enable-notifications-btn hidden" id="enableNotificationsBtn">
        üîî Activar Notificaciones
    </button>

    <!-- OVERLAY CUANDO EST√Å CERRADO (solo usuarios) -->
    <div class="closed-overlay" id="closedOverlay">
        <div class="closed-message">
            <div class="closed-icon">üîí</div>
            <h2>Lo sentimos</h2>
            <p>En este momento estamos <strong>CERRADOS</strong></p>
            <p style="margin-top: 15px; font-size: 1em;">
                Por favor vuelve m√°s tarde para hacer tu pedido.
            </p>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>üçΩÔ∏è Sabor Ecuatoriano</h1>
            <a href="/logout" class="logout-btn">üö™ Cerrar sesi√≥n</a>
            <p class="subtitle">Haz tu pedido f√°cil y r√°pido</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('order')">Hacer Pedido</button>
            <button class="tab" onclick="switchTab('manage')">
                Gestionar Pedidos
                <span class="badge" id="orderCount">0</span>
            </button>
            {% if role == 'admin' %}
            <button class="tab" onclick="switchTab('admin')">üîê Admin</button>
            {% endif %}
        </div>

        <!-- ============================================
             SECCI√ìN DE ADMIN
        ============================================ -->
        <div id="adminSection" class="content-section">
            <h2>Panel de Administraci√≥n</h2>

            <!-- BOT√ìN CLEAN PEQUE√ëO -->
            <button class="clean-all-btn" onclick="confirmCleanAll()">
                üóëÔ∏è Clean
            </button>

            <!-- CONTROL DE ESTADO DEL RESTAURANTE -->
            <div class="status-control">
                <h3>üè™ Estado del Restaurante</h3>
                <div class="status-toggle">
                    <button class="toggle-btn toggle-btn-open active" id="btnOpen" onclick="setRestaurantStatus(true)">
                        ‚úÖ ABIERTO
                    </button>
                    <button class="toggle-btn toggle-btn-closed" id="btnClosed" onclick="setRestaurantStatus(false)">
                        üîí CERRADO
                    </button>
                </div>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

            <h3>Agregar Producto</h3>
            <div style="display: grid; gap: 15px; max-width: 600px; margin-bottom: 30px;">
                <input id="newName" placeholder="Nombre del producto" style="padding: 12px; border-radius: 8px; border: 2px solid #eee; font-size: 1em;">
                <input id="newDescription" placeholder="Descripci√≥n deliciosa" style="padding: 12px; border-radius: 8px; border: 2px solid #eee; font-size: 1em;">
                <input id="newPrice" placeholder="Precio" type="number" step="0.01" style="padding: 12px; border-radius: 8px; border: 2px solid #eee; font-size: 1em;">
                <select id="newCategory" style="padding: 12px; border-radius: 8px; border: 2px solid #eee; font-size: 1em;">
                    <option value="empanadas">ü•ü Empanadas</option>
                    <option value="corviches">üêü Corviches</option>
                    <option value="gatos">üéÅ Gatos Encerrados</option>
                    <option value="bebidas">ü•§ Bebidas</option>
                </select>
                <button onclick="addProduct()" style="padding: 15px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    ‚ú® Agregar Producto
                </button>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

            <h3>Productos Actuales</h3>
            <div id="productsList" style="display: grid; gap: 15px; max-width: 800px;"></div>

            <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

            <h3>Pedidos Globales</h3>
            <div id="adminOrders" class="orders-list"></div>
        </div>

        <!-- ============================================
             SECCI√ìN DE PEDIDOS
        ============================================ -->
        <div id="orderSection" class="content-section active">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: start;">
                <div id="menuContainer"></div>

                <div>
                    <div class="cart-summary">
                        <h2>üìã Tu Pedido</h2>
                        <div id="cartItems">
                            <p style="color: #999; text-align: center; padding: 20px;">
                                No hay productos seleccionados
                            </p>
                        </div>

                        <button class="submit-order" onclick="submitOrder()" id="submitBtn" disabled>
                            Enviar Pedido
                        </button>

                        <!-- BOT√ìN DE PAGO -->
                        <button class="submit-order" style="margin-top:10px;background:#2ecc71"
                            onclick="showPayment()">
                            üí≥ Ver datos de pago
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             SECCI√ìN DE GESTI√ìN
        ============================================ -->
        <div id="manageSection" class="content-section">
            <h3>Gesti√≥n de Pedidos</h3>
            <div id="ordersList" class="orders-list">
                <div class="empty-state">
                    <h3>No hay pedidos todav√≠a</h3>
                    <p>Los pedidos aparecer√°n aqu√≠ en orden cronol√≥gico</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODAL DE CONFIRMACI√ìN DE LIMPIEZA
    ============================================ -->
    <div id="cleanConfirmModal" class="clean-confirm-modal">
        <div class="clean-confirm-box">
            <div class="clean-confirm-icon">‚ö†Ô∏è</div>
            <h3>¬øEliminar Todos los Pedidos?</h3>
            <p>Esta acci√≥n eliminar√° <strong>TODOS</strong> los pedidos actuales. Los usuarios ser√°n notificados autom√°ticamente.</p>
            <p style="color: #999; font-size: 0.9em;">Esta acci√≥n no se puede deshacer.</p>
            
            <div class="clean-confirm-buttons">
                <button class="btn-cancel-clean" onclick="closeCleanModal()">
                    Cancelar
                </button>
                <button class="btn-confirm-clean" onclick="executeCleanAll()">
                    S√≠, Eliminar Todo
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODAL DE PAGO
    ============================================ -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-box">
            <h2>üí≥ Datos para el pago</h2>

            <p>
                <strong>Banco:</strong>
                <span>Banco Pichincha</span>
            </p>

            <p>
                <strong>Tipo:</strong>
                <span>Cuenta de Ahorros</span>
            </p>

            <p>
                <strong>Nombre:</strong>
                <span>Fernando Lorenzo Valeriano Loor</span>
            </p>

            <p>
                <strong>N√∫mero:</strong>
                <span id="cuentaText">2204803284</span>
                <button class="copy-btn" onclick="copyText('cuentaText')" title="Copiar n√∫mero de cuenta">üìã</button>
            </p>

            <p>
                <strong>C√©dula:</strong>
                <span id="cedulaText">1309102372</span>
                <button class="copy-btn" onclick="copyText('cedulaText')" title="Copiar c√©dula">üìã</button>
            </p>

            <p>
                <strong>Celular:</strong>
                <span id="celularText">0958609758</span>
                <button class="copy-btn" onclick="copyText('celularText')" title="Copiar celular">üìã</button>
            </p>

            <p style="background: var(--cream); border-left: 4px solid var(--primary);">
                <strong>Referencia:</strong>
                <span>Pedido Sabor Ecuatoriano</span>
            </p>

            <button onclick="closePayment()">Cerrar</button>
        </div>
    </div>

    <!-- CARGAR SISTEMA DE NOTIFICACIONES -->
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>

    <script>
        const USER_ROLE = "{{ role }}";
        
        const cart = {};
        let orders = [];
        let products = {};
        let prices = {};
        let isRestaurantOpen = true;
        let previousOrders = [];

        // Variable global para control de animaciones
        window.shouldAnimateOrders = false;

        // ============================================
        // SISTEMA DE LIMPIEZA DE PEDIDOS
        // ============================================
        
        function confirmCleanAll() {
            document.getElementById('cleanConfirmModal').classList.add('show');
        }

        function closeCleanModal() {
            document.getElementById('cleanConfirmModal').classList.remove('show');
        }

        function executeCleanAll() {
            fetch('/api/orders/clean-all', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                closeCleanModal();
                
                alert(`‚úÖ ${data.deleted_count} pedido(s) eliminado(s) exitosamente.\nLos usuarios han sido notificados.`);
                
                // Recargar pedidos
                loadOrdersFromServer();
                loadAdminOrders();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar pedidos');
            });
        }

        // Verificar bandera de limpieza (solo usuarios)
        function checkCleanFlag() {
            if (USER_ROLE === 'admin') return;
            
            fetch('/api/check-clean-flag')
                .then(r => r.json())
                .then(data => {
                    if (data.cleaned) {
                        console.log('üîî LIMPIEZA DETECTADA - Mostrando notificaci√≥n al usuario');
                        
                        // Notificaci√≥n del navegador
                        window.notificationSystem.showBrowserNotification(
                            "üîî Sistema Actualizado",
                            "El administrador ha limpiado todos los pedidos. No te preocupes, puedes hacer nuevos pedidos cuando desees.",
                            "üóëÔ∏è"
                        );
                        
                        // Notificaci√≥n visual en pantalla
                        window.notificationSystem.showInPageNotification(
                            "üîî Actualizaci√≥n del Sistema",
                            `<strong>Atenci√≥n:</strong> El administrador ha limpiado todos los pedidos del sistema.<br>
                            <small>No te preocupes, esto es parte del mantenimiento normal. Puedes hacer nuevos pedidos cuando desees.</small>`,
                            'warning'
                        );
                        
                        // Sonido de notificaci√≥n
                        window.notificationSystem.playStatusChangeSound();
                        
                        // Alert adicional para asegurar que lo vean
                        setTimeout(() => {
                            alert('üîî AVISO IMPORTANTE\n\nEl administrador ha limpiado todos los pedidos del sistema para mantener la p√°gina actualizada.\n\n‚úÖ No te preocupes, todo est√° bien.\n‚úÖ Puedes hacer nuevos pedidos normalmente.');
                        }, 500);
                        
                        // Confirmar que vio la notificaci√≥n
                        fetch('/api/confirm-clean-notification', {
                            method: 'POST'
                        });
                        
                        // Recargar pedidos inmediatamente
                        loadOrdersFromServer();
                    }
                })
                .catch(error => {
                    console.error('Error verificando limpieza:', error);
                });
        }

        // ============================================
        // INICIALIZAR SISTEMA DE NOTIFICACIONES
        // ============================================
        
        function checkNotificationPermission() {
            const enableBtn = document.getElementById('enableNotificationsBtn');
            const indicator = document.getElementById('notificationsIndicator');
            const indicatorDot = document.getElementById('notificationDot');
            const indicatorStatus = document.getElementById('notificationStatus');
            
            if (Notification.permission === 'default') {
                enableBtn.classList.remove('hidden');
                indicator.style.display = 'none';
            } else if (Notification.permission === 'granted') {
                enableBtn.classList.add('hidden');
                indicator.style.display = 'flex';
                indicator.className = 'notifications-indicator active';
                indicatorDot.className = 'notification-dot';
                indicatorStatus.textContent = 'Notificaciones Activas';
            } else {
                enableBtn.classList.add('hidden');
                indicator.style.display = 'flex';
                indicator.className = 'notifications-indicator inactive';
                indicatorDot.className = 'notification-dot inactive';
                indicatorStatus.textContent = 'Notificaciones Bloqueadas';
            }
        }

        document.getElementById('enableNotificationsBtn')?.addEventListener('click', () => {
            window.notificationSystem.requestPermission();
            setTimeout(checkNotificationPermission, 500);
        });

        checkNotificationPermission();

        // ============================================
        // SISTEMA DE MENSAJES DE BIENVENIDA
        // ============================================
        const welcomeMessages = {
            morning: [
                "¬°Buenos d√≠as! ‚òÄÔ∏è Empieza tu ma√±ana con el delicioso sabor ecuatoriano",
                "¬°Buen d√≠a! üåÖ Nada mejor que nuestras empanadas para comenzar la ma√±ana",
                "¬°Hola! ‚òï ¬øListo para un desayuno con sabor ecuatoriano?",
                "¬°Buenos d√≠as! üå§Ô∏è El mejor momento para disfrutar nuestras delicias",
                "¬°Qu√© tengas un excelente d√≠a! üåª D√©janos endulzar tu ma√±ana",
                "¬°Buen d√≠a! üåû Comienza con energ√≠a y buen sabor ecuatoriano",
                "¬°Buenos d√≠as! ü•ê Tu dosis matutina de sabor ecuatoriano te espera"
            ],
            afternoon: [
                "¬°Buenas tardes! üå§Ô∏è Perfecto para un break delicioso",
                "¬°Hola! üåÜ La hora ideal para nuestras empanadas calentitas",
                "¬°Buenas tardes! ‚òï Dale un respiro a tu d√≠a con sabor ecuatoriano",
                "¬°Qu√© buena tarde! üå§Ô∏è Recarga energ√≠as con nuestros productos",
                "¬°Hola! üçΩÔ∏è La mejor pausa del d√≠a comienza aqu√≠",
                "¬°Buenas tardes! üåÖ Un antojo a tiempo siempre cae bien",
                "¬°Hola! ‚è∞ Hora de consentirte con algo delicioso"
            ],
            evening: [
                "¬°Buenas noches! üåô Termina tu d√≠a con el mejor sabor ecuatoriano",
                "¬°Hola! ‚ú® La noche es perfecta para nuestras delicias",
                "¬°Buenas noches! üåÉ Satisface tus antojos nocturnos aqu√≠",
                "¬°Qu√© buena noche! üåô El sabor ecuatoriano te acompa√±a siempre",
                "¬°Hola! üå† Disfruta la noche con nuestros productos artesanales",
                "¬°Buenas noches! üåå Termina el d√≠a de la mejor manera",
                "¬°Hola! üåô Los mejores sabores para cerrar tu jornada"
            ]
        };

        function showWelcomeMessage() {
            const hour = new Date().getHours();
            let timeOfDay;
            
            if (hour >= 5 && hour < 12) {
                timeOfDay = 'morning';
            } else if (hour >= 12 && hour < 19) {
                timeOfDay = 'afternoon';
            } else {
                timeOfDay = 'evening';
            }
            
            const messages = welcomeMessages[timeOfDay];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            const toast = document.createElement('div');
            toast.className = 'welcome-toast';
            toast.innerHTML = `
                <div class="welcome-toast-content">
                    <h3>üçΩÔ∏è ¬°Bienvenido${USER_ROLE === 'admin' ? ' Admin' : ''}!</h3>
                    <p>${randomMessage}</p>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        window.addEventListener('load', () => {
            setTimeout(showWelcomeMessage, 500);
        });

        // ============================================
        // CONFIGURACI√ìN DE CATEGOR√çAS
        // ============================================
        const categoryEmojis = {
            'empanadas': 'ü•ü',
            'corviches': 'üêü',
            'gatos': 'üéÅ',
            'bebidas': 'ü•§'
        };

        const categoryNames = {
            'empanadas': 'Empanadas',
            'corviches': 'Corviches',
            'gatos': 'Gatos Encerrados',
            'bebidas': 'Bebidas'
        };

        // ============================================
        // GESTI√ìN DE ESTADO DEL RESTAURANTE
        // ============================================
        
        function loadRestaurantStatus() {
            fetch('/api/restaurant-status')
                .then(r => r.json())
                .then(data => {
                    isRestaurantOpen = data.is_open;
                    updateStatusUI();
                    
                    if (USER_ROLE !== 'admin' && !isRestaurantOpen) {
                        document.getElementById('closedOverlay').classList.add('show');
                    }
                })
                .catch(error => {
                    console.error('Error cargando estado:', error);
                });
        }

        function updateStatusUI() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const btnOpen = document.getElementById('btnOpen');
            const btnClosed = document.getElementById('btnClosed');
            const overlay = document.getElementById('closedOverlay');
            
            if (isRestaurantOpen) {
                indicator.className = 'status-indicator status-open';
                statusText.textContent = 'ABIERTO';
                statusText.className = 'status-text-open';
                
                if (btnOpen && btnClosed) {
                    btnOpen.classList.add('active');
                    btnClosed.classList.remove('active');
                }
                
                if (overlay) {
                    overlay.classList.remove('show');
                }
            } else {
                indicator.className = 'status-indicator status-closed';
                statusText.textContent = 'CERRADO';
                statusText.className = 'status-text-closed';
                
                if (btnOpen && btnClosed) {
                    btnOpen.classList.remove('active');
                    btnClosed.classList.add('active');
                }
                
                if (USER_ROLE !== 'admin' && overlay) {
                    overlay.classList.add('show');
                }
            }
        }

        function setRestaurantStatus(isOpen) {
            if (USER_ROLE !== 'admin') return;
            
            fetch('/api/restaurant-status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_open: isOpen })
            })
            .then(r => r.json())
            .then(data => {
                isRestaurantOpen = data.is_open;
                updateStatusUI();
                
                const message = isOpen ? '‚úÖ Restaurante ABIERTO' : 'üîí Restaurante CERRADO';
                alert(message);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el estado');
            });
        }

        // ============================================
        // CARGAR PRODUCTOS
        // ============================================
        
        function loadProducts() {
            fetch('/api/products')
            .then(r => r.json())
            .then(data => {
                products = data;
                
                prices = {};
                for (let cat in products) {
                    products[cat].forEach(p => {
                        prices[p.id] = p.price;
                    });
                }
                
                renderMenu();
                
                if (USER_ROLE === 'admin') {
                    renderProductsList();
                }
                
                console.log('Productos cargados y men√∫ actualizado');
            })
            .catch(error => {
                console.error('Error cargando productos:', error);
            });
        }

        function renderMenu() {
            const menuContainer = document.getElementById('menuContainer');
            let html = '';

            const categoryOrder = ['empanadas', 'corviches', 'gatos', 'bebidas'];

            categoryOrder.forEach(category => {
                if (!products[category] || products[category].length === 0) return;

                const emoji = categoryEmojis[category] || 'üç¥';
                const categoryName = categoryNames[category] || category;
                const price = products[category][0].price.toFixed(2);

                html += `
                    <h2 style="font-family: 'Righteous', cursive; font-size: 2em; margin: 30px 0 20px; color: var(--primary);">
                        ${emoji} ${categoryName} $${price}
                    </h2>
                    <div class="menu-grid">
                `;

                products[category].forEach(product => {
                    html += `
                        <div class="menu-item">
                            <h3>${product.name}</h3>
                            <p style="color: #666; margin: 10px 0;">${product.description}</p>
                            <div class="quantity-control">
                                <button onclick="changeQuantity('${product.id}', -1)">‚àí</button>
                                <span class="quantity-display" id="qty-${product.id}">0</span>
                                <button onclick="changeQuantity('${product.id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            menuContainer.innerHTML = html;
            
            for (let productId in cart) {
                const qtyElement = document.getElementById(`qty-${productId}`);
                if (qtyElement && cart[productId] > 0) {
                    qtyElement.textContent = cart[productId];
                }
            }
        }

        function getProductName(id){
            for(let cat in products){
                const p = products[cat].find(x=>x.id===id);
                if(p) return p.name;
            }
            return id;
        }

        // ============================================
        // CARRITO DE COMPRAS
        // ============================================
        
        function changeQuantity(item, delta) {
            if (!cart[item]) cart[item] = 0;
            cart[item] = Math.max(0, cart[item] + delta);
            const qtyElement = document.getElementById(`qty-${item}`);
            if (qtyElement) {
                qtyElement.textContent = cart[item];
            }
            updateCart();
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const submitBtn = document.getElementById('submitBtn');
            const items = Object.entries(cart).filter(([_, qty]) => qty > 0);

            if (items.length === 0) {
                cartItems.innerHTML = '<p style="color:#999;text-align:center">No hay productos</p>';
                submitBtn.disabled = true;
            } else {
                let total = 0;
                cartItems.innerHTML = items.map(([item, qty]) => {
                    const subtotal = (prices[item] || 0) * qty;
                    total += subtotal;
                    return `
                        <div class="cart-item">
                            <span><strong>${getProductName(item)}</strong></span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                    `;
                }).join('') + `
                    <hr>
                    <div class="cart-item">
                        <strong>Total</strong>
                        <strong style="color:var(--primary)">$${total.toFixed(2)}</strong>
                    </div>
                `;
                submitBtn.disabled = false;
            }
        }

        function submitOrder() {
            if (!isRestaurantOpen && USER_ROLE !== 'admin') {
                alert('‚ö†Ô∏è Lo sentimos, el restaurante est√° cerrado en este momento.');
                return;
            }

            const items = Object.entries(cart)
                .filter(([_, qty]) => qty > 0)
                .map(([k, v]) => ({
                    name: k,
                    quantity: v
                }));

            if (items.length === 0) return;

            fetch('/api/orders', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ items })
            })
            .then(r=>r.json())
            .then(order=>{
                alert("¬°Pedido enviado con √©xito!");

                Object.keys(cart).forEach(k=>{
                    cart[k]=0;
                    const qtyElement = document.getElementById(`qty-${k}`);
                    if (qtyElement) {
                        qtyElement.textContent = 0;
                    }
                });
                updateCart();

                loadOrdersFromServer();
                
                if (USER_ROLE === 'admin') {
                    loadAdminOrders();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al enviar el pedido');
            });
        }

        // ============================================
        // GESTI√ìN DE PEDIDOS CON NOTIFICACIONES (CORREGIDO)
        // ============================================
        
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay pedidos todav√≠a</h3>
                        <p>Los pedidos aparecer√°n aqu√≠ en orden cronol√≥gico</p>
                    </div>
                `;
                return;
            }

            const statusText = {
                pending: 'Pendiente',
                preparing: 'Preparando',
                ready: 'Listo',
                delivered: 'Entregado'
            };

            ordersList.innerHTML = orders.map(order => {
                let total = 0;
                
                let displayName = order.username;
                if (!displayName && order.user_id) {
                    if (order.user_id === 'admin') {
                        displayName = 'Administrador';
                    } else if (order.user_id.includes('_')) {
                        const parts = order.user_id.split('_');
                        displayName = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                    } else {
                        displayName = 'Usuario';
                    }
                }

                const animateClass = window.shouldAnimateOrders ? ' animate' : '';

                return `
                    <div class="order-card${animateClass}">
                        <div class="order-header">
                            <div>
                                <div class="order-number">Pedido #${order.id}</div>
                                ${displayName ? `<div class="order-user">üë§ ${displayName}</div>` : ''}
                                <div class="order-time">
                                    ${new Date(order.timestamp).toLocaleString('es-EC')}
                                </div>
                            </div>
                            <span class="status-badge status-${order.status}">
                                ${statusText[order.status]}
                            </span>
                        </div>

                        <div class="order-items">
                            ${order.items.map(i=>{
                                const sub = (prices[i.name] || 0) * i.quantity;
                                total += sub;
                                return `
                                    <div class="order-item">
                                        <span>${getProductName(i.name)} x${i.quantity}</span>
                                        <span>$${sub.toFixed(2)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="order-item" style="font-weight:700">
                            <span>Total</span>
                            <span style="color:var(--primary)">
                                $${total.toFixed(2)}
                            </span>
                        </div>

                        ${USER_ROLE === 'admin' ? `
                        <div class="status-buttons">
                            ${order.status==='pending' ? `
                                <button class="status-btn btn-preparing" onclick="updateOrderStatus(${order.id},'preparing')">
                                    üç≥ Marcar Preparando
                                </button>` : ''}

                            ${order.status==='preparing' ? `
                                <button class="status-btn btn-ready" onclick="updateOrderStatus(${order.id},'ready')">
                                    ‚úÖ Marcar Listo
                                </button>` : ''}

                            ${order.status==='ready' ? `
                                <button class="status-btn btn-delivered" onclick="updateOrderStatus(${order.id},'delivered')">
                                    üöÄ Marcar Entregado
                                </button>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateOrderStatus(orderId, newStatus) {
            console.log(`üìù Actualizando pedido #${orderId} a estado: ${newStatus}`);
            
            fetch(`/api/orders/${orderId}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ status: newStatus })
            })
            .then(r=>r.json())
            .then((updatedOrder)=>{
                console.log(`‚úÖ Pedido #${orderId} actualizado exitosamente`);
                
                // Actualizar inmediatamente en el array local
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = newStatus;
                    console.log(`üìã Estado local actualizado para pedido #${orderId}`);
                }
                
                // Re-renderizar inmediatamente
                window.shouldAnimateOrders = true;
                renderOrders();
                
                // Cargar del servidor para confirmar
                setTimeout(() => {
                    loadOrdersFromServer();
                    if (USER_ROLE === 'admin') {
                        loadAdminOrders();
                    }
                }, 100);
                
                setTimeout(() => {
                    window.shouldAnimateOrders = false;
                }, 600);
            })
            .catch(error => {
                console.error('‚ùå Error al actualizar el estado:', error);
                alert('Error al actualizar el estado');
            });
        }

        function loadOrdersFromServer(){
            fetch('/api/orders')
            .then(r=>r.json())
            .then(data=>{
                console.log(`üì• Pedidos recibidos del servidor: ${data.length}`);
                
                // ADMIN: Detectar nuevos pedidos
                if (USER_ROLE === 'admin') {
                    window.notificationSystem.checkForNewOrders(data);
                }
                
                // USUARIO: Detectar cambios de estado
                if (USER_ROLE === 'user') {
                    window.notificationSystem.checkForStatusChanges(data);
                }
                
                // Actualizar el array global de pedidos
                orders = data;
                
                // Actualizar contador de pedidos
                document.getElementById('orderCount').textContent = orders.length;
                
                // Re-renderizar pedidos (esto actualiza la UI)
                renderOrders();
                
                // Guardar copia para la pr√≥xima comparaci√≥n
                previousOrders = JSON.parse(JSON.stringify(data));
            })
            .catch(error => {
                console.error('‚ùå Error cargando pedidos:', error);
            });
        }

        function loadAdminOrders(){
            const adminOrders = document.getElementById('adminOrders');
            
            if (!adminOrders) {
                console.log('‚ö†Ô∏è Elemento adminOrders no encontrado');
                return;
            }
            
            fetch('/api/orders')
            .then(r=>r.json())
            .then(data=>{
                console.log(`üì• Pedidos globales actualizados: ${data.length}`);
                
                if (USER_ROLE === 'admin') {
                    window.notificationSystem.checkForNewOrders(data);
                }
                
                if (data.length === 0) {
                    adminOrders.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No hay pedidos todav√≠a</p>';
                    return;
                }

                const statusText = {
                    pending: 'Pendiente',
                    preparing: 'Preparando',
                    ready: 'Listo',
                    delivered: 'Entregado'
                };

                adminOrders.innerHTML = data.map(order=>{
                    let total = 0;
                    
                    let displayName = order.username;
                    if (!displayName && order.user_id) {
                        if (order.user_id === 'admin') {
                            displayName = 'Administrador';
                        } else if (order.user_id.includes('_')) {
                            const parts = order.user_id.split('_');
                            displayName = parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                        } else {
                            displayName = 'Usuario';
                        }
                    }

                    const animateClass = window.shouldAnimateOrders ? ' animate' : '';

                    return `
                        <div class="order-card${animateClass}">
                            <div class="order-header">
                                <div>
                                    <div class="order-number">Pedido #${order.id}</div>
                                    ${displayName ? `<div class="order-user">üë§ ${displayName}</div>` : ''}
                                    <div class="order-time">
                                        ${new Date(order.timestamp).toLocaleString('es-EC')}
                                    </div>
                                </div>
                                <span class="status-badge status-${order.status}">
                                    ${statusText[order.status]}
                                </span>
                            </div>

                            <div class="order-items">
                                ${order.items.map(i=>{
                                    const sub = (prices[i.name] || 0)*i.quantity;
                                    total += sub;
                                    return `
                                        <div class="order-item">
                                            <span>${getProductName(i.name)} x${i.quantity}</span>
                                            <span>$${sub.toFixed(2)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="order-item" style="font-weight:700">
                                <span>Total</span>
                                <span style="color:var(--primary)">
                                    $${total.toFixed(2)}
                                </span>
                            </div>

                            <div class="status-buttons">
                                ${order.status==='pending' ? `
                                    <button class="status-btn btn-preparing" onclick="updateOrderStatus(${order.id},'preparing')">
                                        üç≥ Marcar Preparando
                                    </button>` : ''}

                                ${order.status==='preparing' ? `
                                    <button class="status-btn btn-ready" onclick="updateOrderStatus(${order.id},'ready')">
                                        ‚úÖ Marcar Listo
                                    </button>` : ''}

                                ${order.status==='ready' ? `
                                    <button class="status-btn btn-delivered" onclick="updateOrderStatus(${order.id},'delivered')">
                                        üöÄ Marcar Entregado
                                    </button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('‚ùå Error cargando pedidos globales:', error);
                adminOrders.innerHTML = '<p style="color:red; text-align: center; padding: 20px;">Error cargando pedidos. Reintentando...</p>';
            });
        }

        // ============================================
        // GESTI√ìN DE PRODUCTOS (ADMIN)
        // ============================================
        
        function addProduct() {
            const name = document.getElementById('newName').value.trim();
            const description = document.getElementById('newDescription').value.trim();
            const price = parseFloat(document.getElementById('newPrice').value);
            const category = document.getElementById('newCategory').value;

            if (!name || !description || isNaN(price) || price <= 0) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            fetch('/api/products', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    description: description,
                    price: price,
                    category: category
                })
            })
            .then(r => r.json())
            .then(() => {
                alert('‚ú® ¬°Producto agregado con √©xito!');
                
                document.getElementById('newName').value = '';
                document.getElementById('newDescription').value = '';
                document.getElementById('newPrice').value = '';
                
                loadProducts();
                
                console.log('Producto agregado - actualizando todas las vistas');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar producto');
            });
        }

        function deleteProduct(productId) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;

            fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            })
            .then(r => r.json())
            .then(() => {
                alert('‚úÖ Producto eliminado con √©xito');
                
                loadProducts();
                
                console.log('Producto eliminado - actualizando todas las vistas');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar producto');
            });
        }

        function renderProductsList() {
            const productsList = document.getElementById('productsList');
            let html = '';

            for (let category in products) {
                const emoji = categoryEmojis[category] || 'üç¥';
                const categoryName = categoryNames[category] || category;

                products[category].forEach(product => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">
                                    ${emoji} ${product.name}
                                </div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">
                                    ${product.description}
                                </div>
                                <div style="color: var(--primary); font-weight: 700;">
                                    $${product.price.toFixed(2)} - ${categoryName}
                                </div>
                            </div>
                            <button onclick="deleteProduct('${product.id}')" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    `;
                });
            }

            productsList.innerHTML = html || '<p>No hay productos todav√≠a</p>';
        }

        // ============================================
        // MODAL DE PAGO
        // ============================================
        
        function showPayment(){
            document.getElementById("paymentModal").style.display = "flex";
        }

        function closePayment(){
            document.getElementById("paymentModal").style.display = "none";
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text);

            const btn = event.target;
            const original = btn.innerHTML;
            btn.innerHTML = "‚úî";
            btn.style.background = "#2ecc71";

            setTimeout(() => {
                btn.innerHTML = original;
                btn.style.background = "";
            }, 1200);
        }

        // ============================================
        // NAVEGACI√ìN ENTRE TABS
        // ============================================
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            if (tab === 'order') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('orderSection').classList.add('active');
            } 
            else if (tab === 'manage') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('manageSection').classList.add('active');
                loadOrdersFromServer();
            }
            else if (tab === 'admin') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('adminSection').classList.add('active');
                loadAdminOrders();
                renderProductsList();
            }
        }

        // ============================================
        // SISTEMA DE ACTUALIZACI√ìN PARA M√ìVILES (CR√çTICO)
        // ============================================
        
        // Variables de control
        let updateIntervalId = null;
        let updateTimeoutId = null;
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 2000; // 2 segundos - M√ÅS FRECUENTE
        let isUpdating = false;
        
        // Funci√≥n de actualizaci√≥n mejorada
        function forceUpdate() {
            if (isUpdating) {
                console.log('‚è≥ Actualizaci√≥n en progreso, esperando...');
                return;
            }
            
            isUpdating = true;
            console.log('üîÑ Forzando actualizaci√≥n completa...');
            
            Promise.all([
                loadOrdersFromServer(),
                USER_ROLE === 'admin' ? loadAdminOrders() : Promise.resolve()
            ]).then(() => {
                console.log('‚úÖ Actualizaci√≥n completa finalizada');
                isUpdating = false;
                lastUpdateTime = Date.now();
            }).catch(error => {
                console.error('‚ùå Error en actualizaci√≥n:', error);
                isUpdating = false;
            });
        }
        
        // Loop de actualizaci√≥n continua usando requestAnimationFrame
        function continuousUpdate() {
            const now = Date.now();
            
            if (now - lastUpdateTime >= UPDATE_INTERVAL && !isUpdating) {
                forceUpdate();
            }
            
            // Continuar el loop
            requestAnimationFrame(continuousUpdate);
        }
        
        // Detectar cuando la p√°gina vuelve a estar visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üì± P√°gina visible - Forzando actualizaci√≥n inmediata');
                forceUpdate();
            }
        });
        
        // Detectar cuando la ventana vuelve a tener foco
        window.addEventListener('focus', function() {
            console.log('üì± Ventana enfocada - Forzando actualizaci√≥n inmediata');
            forceUpdate();
        });
        
        // Detectar cuando el usuario toca la pantalla (m√≥viles)
        let lastTouchUpdate = 0;
        document.addEventListener('touchstart', function() {
            const now = Date.now();
            // Solo actualizar si han pasado m√°s de 5 segundos desde el √∫ltimo toque
            if (now - lastTouchUpdate > 5000) {
                console.log('üëÜ Touch detectado - Verificando actualizaciones');
                forceUpdate();
                lastTouchUpdate = now;
            }
        }, { passive: true });
        
        // Detectar scroll (el usuario est√° activo)
        let lastScrollUpdate = 0;
        window.addEventListener('scroll', function() {
            const now = Date.now();
            // Solo actualizar si han pasado m√°s de 10 segundos desde el √∫ltimo scroll
            if (now - lastScrollUpdate > 10000) {
                console.log('üìú Scroll detectado - Verificando actualizaciones');
                forceUpdate();
                lastScrollUpdate = now;
            }
        }, { passive: true });

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        loadProducts();
        updateCart();
        loadRestaurantStatus();
        
        // Inicializar estados sin notificar
        fetch('/api/orders')
            .then(r => r.json())
            .then(data => {
                console.log('üé¨ Inicializando sistema con', data.length, 'pedidos');
                window.notificationSystem.initializeStates(data);
                orders = data;
                document.getElementById('orderCount').textContent = orders.length;
                renderOrders();
                lastUpdateTime = Date.now();
                
                // Iniciar loop de actualizaci√≥n continua
                console.log('üöÄ Iniciando sistema de actualizaci√≥n continua para m√≥viles');
                requestAnimationFrame(continuousUpdate);
            });

        // Intervalos tradicionales (respaldo)
        setInterval(() => {
            if (!isUpdating) {
                loadOrdersFromServer();
            }
        }, 3000);
        
        setInterval(loadRestaurantStatus, 10000);
        setInterval(loadProducts, 10000);
        
        // Verificar bandera de limpieza cada 1 segundo (solo usuarios)
        if (USER_ROLE === 'user') {
            setInterval(checkCleanFlag, 1000);
            checkCleanFlag();
        }
        
        // Actualizaci√≥n de pedidos admin
        if (USER_ROLE === 'admin') {
            setInterval(() => {
                if (!isUpdating) {
                    const adminSection = document.getElementById('adminSection');
                    if (adminSection && adminSection.classList.contains('active')) {
                        loadAdminOrders();
                    }
                }
            }, 3000);
        }
        
        console.log('‚úÖ Sistema de actualizaci√≥n m√≥vil completamente activado');
        console.log('üì± M√©todos activos: visibilitychange, focus, touch, scroll, requestAnimationFrame, setInterval');
    </script>
</body>
</html>